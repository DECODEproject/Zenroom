<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        html, body { overflow: hidden; height: 100%; }
        #output { font-family: "Monaco", "Menlo", "Ubuntu Mono", "Consolas", "source-code-pro", monospace }
        #output, #input { font-size: 13px; overflow: auto; padding-bottom: 140px; margin-bottom: 20px; }
    </style>
    <title>Zenroom online demo</title>
  </head>
  <body>
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">
            <img src="https://www.dyne.org/wp-content/uploads/2011/09/dyne-big.png" height="30" class="d-inline-block align-top" alt="">
            &nbsp;Zenroom
        </a>
    </nav>
    <div class="container-fluid h-100">
        <div class="row no-gutters">
            <div class="col-6">
                <button type="button" id="run" class="btn btn-outline-secondary rounded-0 my-4 float-right">
                    <i class="material-icons align-middle">play_circle_filled</i>
                    <span class="align-middle">Run (&#8984; + Enter)</span>
                </button>
            </div>
        </div>
        <div class="row h-100">
            <div id="input"  class="col-6"></div>
            <div id="output" class="col bg-dark text-light pt-3"></div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.3.1/ace.js"></script>
    {{{ SCRIPT }}}
    <script>
        var Module = {
            preRun: [],
            postRun: [],
            print: (function() {
                var element = document.getElementById('output');
                if (element) element.innerHTML = ''; // clear browser cache
                return function(text) {
                    if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                    text = text.replace(/&/g, "&amp;");
                    text = text.replace(/</g, "&lt;");
                    text = text.replace(/>/g, "&gt;");
                    text = text.replace('\n', '<br>', 'g');
                    if (element) {
                        element.innerHTML += text + "<br>";
                        element.scrollTop = element.scrollHeight;
                    }
                };
            })(),
            printErr: function(text) {
                if (!text.startsWith('[!]')) return
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                if (0) { // XXX disabled for safety typeof dump == 'function') {
                    dump(text + '\n'); // fast, straight to the real console
                } else {
                    console.error(text);
                    var element = document.getElementById('output');
                    if (element) { 
                        element.innerHTML += "<span class='bg-danger'>" + text + "</span><br>";
                        element.scrollTop = element.scrollHeight;
                    }
                }
            },
        }

        var zenroom = function() {
            Module.ccall('zenroom_exec', 
                             'number',
                             ['string', 'string', 'string', 'string', 'number'],
                             [editor.getValue(), null, null, null, 3]);
        }

        var editor = ace.edit("input");
        editor.session.setMode("ace/mode/lua");
        editor.focus();
        editor.commands.addCommand({
            name: 'run',
            bindKey: {win: 'Ctrl-Enter',  mac: 'Command-Enter'},
            exec: function(editor) { zenroom(); }
        });

        $(function() {
            $('#run').click(zenroom);
        });
    </script>
</body>
</html>
