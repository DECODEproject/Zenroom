#!/usr/bin/env zsh

# script to take all extensions in src/lua and embed them inside
# zenroom as strings

[[ -d src/lua ]] || {
	print "error - directory not found: src/lua"
	return 1
}


cat <<EOF > src/lualibs_detected.c
// This file is generated by running build/embed-lualibs
#include <jutils.h>
#include <luasandbox.h>

EOF
libs=`find src/lua -type f -name '*.lua'`
for i in ${(f)libs}; do
	p=`basename $i`
	n=${p[(ws:.:)1]}
	print "#include <lualib_$n.c>" >> src/lualibs_detected.c
done

cat <<EOF >> src/lualibs_detected.c

extern void lsb_load_string(lsb_lua_sandbox *lsb, const char *code,
	                        size_t size, char *name);

int lualibs_detected_load(lsb_lua_sandbox *lsb) {

EOF
c=0
for i in ${(f)libs}; do
	p=`basename $i`
	n=${p[(ws:.:)1]}
	f="lualib_${n}.c"
	print "+ src/$f"
	xxd -i $i > src/$f
	cat <<EOF >> src/lualibs_detected.c
func("loading $n");
lsb_load_string(lsb, (const char*)src_lua_${n}_lua,
					 src_lua_${n}_lua_len, "${n}");
EOF
	c=$(( c + 1 ))
done

cat <<EOF >> src/lualibs_detected.c
	return($c);
}

EOF
